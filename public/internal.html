<!doctype html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Clairvoyant GRC ‚Äî Internal Dashboard</title>
<style>
:root {
  /* Updated color scheme to match main page */
  --primary: #1e40af;
  --primary-dark: #1e3a8a;
  --primary-light: #3b82f6;
  --secondary: #10b981;
  --dark: #111827;
  --dark-lighter: #1f2937;
  --gray: #6b7280;
  --gray-light: #9ca3af;
  --white: #ffffff;
  --background: #f9fafb;
  --border: #e5e7eb;
  
  /* Dashboard specific colors */
  --panel: #ffffff;
  --panel-2: #f9fafb;
  --text: #111827;
  --muted: #6b7280;
  --accent: #3b82f6;
  
  /* Status colors */
  --ok: #10b981;
  --warn: #f59e0b;
  --bad: #ef4444;
  --purple: #8b5cf6;
  --amber: #f59e0b;
  --green: #10b981;
  --blue: #3b82f6;
  
  /* UI properties */
  --radius: 10px;
  --border-style: 1px solid #e5e7eb;
  --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: var(--background);
  color: var(--text);
  line-height: 1.6;
}

a{color:inherit;text-decoration:none}

.app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}

/* Sidebar */
.aside{
  background:var(--white);
  border-right:var(--border-style);
  padding:24px 20px;
  position:sticky;
  top:0;
  height:100vh;
  box-shadow: var(--shadow);
}

.brand{
  display:flex;
  align-items:center;
  gap:12px;
  margin-bottom:32px;
}

.logo{
  width:55px;
  height:55px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.logo img{
  width:100%;
  height:100%;
  object-fit:contain;
}

.brand h1{
  font-size:20px;
  font-weight:700;
  margin:0;
  color:var(--dark);
}

.nav .section{
  color:var(--muted);
  font-size:11px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin:24px 12px 8px;
}

.nav a{
  display:flex;
  align-items:center;
  gap:10px;
  color:var(--gray);
  text-decoration:none;
  padding:10px 12px;
  border-radius:8px;
  margin:2px 0;
  font-weight:500;
  transition:all 0.2s;
}

.nav a:hover{
  background:var(--panel-2);
  color:var(--dark);
}

.nav a.active{
  background:rgba(30, 64, 175, 0.1);
  color:var(--primary);
}

/* Main content */
.main{
  padding:24px 32px;
  background:var(--background);
}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:24px;
  background:var(--white);
  padding:16px 24px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
}

.search{
  background:var(--panel-2);
  border:var(--border-style);
  border-radius:8px;
  padding:10px 16px;
  display:flex;
  align-items:center;
  gap:10px;
  min-width:320px;
}

.search input{
  background:transparent;
  border:none;
  outline:none;
  color:var(--text);
  width:100%;
  font-size:14px;
}

.search input::placeholder{
  color:var(--gray-light);
}

.user{
  display:flex;
  align-items:center;
  gap:12px;
  font-weight:500;
}

.avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  background:linear-gradient(135deg, var(--primary), var(--primary-light));
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-size:16px;
}

h2.title{
  margin:0 0 24px;
  font-size:28px;
  font-weight:800;
  color:var(--dark);
}

.grid{
  display:grid;
  grid-template-columns:repeat(12,1fr);
  gap:20px;
}

.card{
  background:var(--white);
  border:var(--border-style);
  border-radius:var(--radius);
  padding:20px;
  box-shadow:var(--shadow);
}

.col-3{grid-column:span 3}
.col-4{grid-column:span 4}
.col-6{grid-column:span 6}
.col-8{grid-column:span 8}
.col-12{grid-column:span 12}

/* KPIs */
.kpis{
  display:flex;
  gap:16px;
  flex-wrap:wrap;
}

.kpi{
  flex:1;
  min-width:180px;
  background:var(--panel-2);
  border:var(--border-style);
  border-radius:var(--radius);
  padding:16px;
}

.kpi .label{
  color:var(--muted);
  font-size:12px;
  font-weight:500;
  text-transform:uppercase;
  letter-spacing:0.5px;
}

.kpi .value{
  font-size:28px;
  font-weight:700;
  margin-top:8px;
  color:var(--dark);
}

.badge{
  display:inline-block;
  padding:2px 10px;
  border-radius:999px;
  font-size:11px;
  background:rgba(30, 64, 175, 0.1);
  color:var(--primary);
  font-weight:600;
}

/* Buttons */
.btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 16px;
  border-radius:8px;
  border:var(--border-style);
  background:var(--white);
  color:var(--text);
  text-decoration:none;
  cursor:pointer;
  font-weight:500;
  font-size:14px;
  transition:all 0.2s;
}

.btn:hover{
  background:var(--panel-2);
  box-shadow:var(--shadow);
}

.btn.primary{
  background:var(--primary);
  color:white;
  border:none;
}

.btn.primary:hover{
  background:var(--primary-dark);
}

.btn.success{
  background:var(--ok);
  color:white;
  border:none;
}

.btn.warn{
  background:var(--warn);
  color:white;
  border:none;
}

.btn.ghost{
  background:transparent;
  border:none;
}

/* Table */
.table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

.table th,.table td{
  border-bottom:var(--border-style);
  padding:12px;
  text-align:left;
  color:var(--text);
}

.table th{
  color:var(--muted);
  font-weight:600;
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:0.5px;
  background:var(--panel-2);
}

.table tr:hover{
  background:var(--panel-2);
}

/* Pills/Status */
.pill{
  border-radius:999px;
  padding:4px 12px;
  font-size:12px;
  font-weight:600;
  display:inline-block;
}

.pill.ok{
  background:rgba(16, 185, 129, 0.1);
  color:var(--ok);
}

.pill.warn{
  background:rgba(245, 158, 11, 0.1);
  color:var(--warn);
}

.pill.bad{
  background:rgba(239, 68, 68, 0.1);
  color:var(--bad);
}

.footer{
  color:var(--muted);
  font-size:13px;
  margin-top:12px;
  line-height:1.5;
}

/* Toast notification */
.toast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:var(--dark);
  color:white;
  padding:12px 20px;
  border-radius:8px;
  display:none;
  box-shadow:var(--shadow-lg);
  animation:slideIn 0.3s ease;
}

@keyframes slideIn{
  from{transform:translateY(100px);opacity:0}
  to{transform:translateY(0);opacity:1}
}

/* Card headers */
h3{
  margin:0 0 16px 0;
  font-size:18px;
  font-weight:700;
  color:var(--dark);
}

h4{
  margin:0 0 8px 0;
  font-size:16px;
  font-weight:600;
  color:var(--dark);
}

/* Responsive */
@media (max-width: 768px) {
  .app{
    grid-template-columns:1fr;
  }
  .aside{
    position:relative;
    height:auto;
  }
  .grid{
    grid-template-columns:1fr;
  }
  .col-3,.col-4,.col-6,.col-8,.col-12{
    grid-column:span 1;
  }
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background-color: var(--white);
  margin: 50px auto;
  padding: 0;
  border-radius: var(--radius);
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateY(-30px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-header {
  padding: 20px 24px;
  background: linear-gradient(135deg, var(--primary), var(--primary-light));
  color: white;
  border-radius: var(--radius) var(--radius) 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h2 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
}

.modal-close {
  color: white;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  background: none;
  border: none;
  opacity: 0.8;
  transition: opacity 0.2s;
  line-height: 1;
}

.modal-close:hover {
  opacity: 1;
}

.modal-body {
  padding: 24px;
}

.modal-body textarea {
  width: 100%;
  min-height: 200px;
  padding: 12px;
  border: var(--border-style);
  border-radius: 8px;
  font-family: 'Monaco', 'Courier New', monospace;
  font-size: 13px;
  resize: vertical;
  background: var(--panel-2);
}

.modal-body textarea:focus {
  outline: none;
  border-color: var(--primary);
}

.modal-footer {
  padding: 16px 24px;
  background: var(--panel-2);
  border-top: var(--border-style);
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  border-radius: 0 0 var(--radius) var(--radius);
}

.modal-results {
  background: var(--panel-2);
  border-radius: 8px;
  padding: 16px;
  margin-top: 16px;
  max-height: 400px;
  overflow-y: auto;
  font-family: 'Monaco', 'Courier New', monospace;
  font-size: 13px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.loading-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid var(--gray-light);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
<!-- SheetJS library for Excel manipulation -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head><body>
<div class="app">
  <aside class="aside">
    <div class="brand">
      <div class="logo"><img src="/logo.svg" alt="Clairvoyant GRC Logo"></div>
      <h1>Clairvoyant GRC</h1>
    </div>
    <nav class="nav">
      <div class="section">Internal Audit</div>
      <a href="#" onclick="notImplemented(event)" class="active">üìä Dashboard</a>
      <a href="#evidence">üìÅ Evidence</a>
      <a href="#tests">üß™ Tests</a>
      <a href="#reports">üìÑ Reports</a>
      <div class="section">AI Assistants</div>
      <a href="/sox-auditor.html">ü§ñ SOX Auditor</a>
      <a href="/big4-reviewer.html">üîç Big 4 Reviewer</a>
      <div class="section">Account</div>
      <a href="/">‚¨Ö Back to Home</a>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="search">
        <span style="color:var(--gray-light)">üîé</span>
        <input placeholder="Search controls, tests, or reports..."/>
      </div>
      <div class="user">
        <div class="avatar">IA</div>
        <span>Internal Auditor</span>
      </div>
    </div>

    <h2 class="title">SOX Compliance Dashboard</h2>

    <section class="grid">
      <div class="card col-8">
        <div class="kpis">
          <div class="kpi">
            <div class="label">Controls Tested</div>
            <div class="value">12</div>
            <div class="badge" style="margin-top:8px">Q4 2024</div>
          </div>
          <div class="kpi">
            <div class="label">Effectiveness Rate</div>
            <div class="value" style="color:var(--ok)">83%</div>
            <div class="badge" style="margin-top:8px">‚Üë 5% from Q3</div>
          </div>
          <div class="kpi">
            <div class="label">Open Exceptions</div>
            <div class="value"><span class="pill warn">4</span></div>
            <div class="badge" style="margin-top:8px">2 Critical</div>
          </div>
        </div>
        <div class="footer" style="margin-top:20px">
          Real-time SOX compliance metrics. Use the AI assistants below to automate testing and reviews.
        </div>
      </div>
      <div class="card col-4">
        <h3>Quick Actions</h3>
        <a class="btn primary" href="#evidence" style="width:100%">üì§ Upload Evidence</a>
        <div style="height:12px"></div>
        <a class="btn" href="/sox-auditor.html" style="width:100%">ü§ñ Run SOX Agent</a>
        <div style="height:12px"></div>
        <a class="btn" href="/big4-reviewer.html" style="width:100%">üîç Start Review</a>
      </div>

      <div id="evidence" class="card col-12">
        <h3>Evidence Collection</h3>
        <p class="footer">Upload CSV exports from your systems for automated control testing.</p>
        <div class="grid" style="margin-top:20px">
          <div class="card col-4" style="background:var(--panel-2)">
            <h4>HR System</h4>
            <p class="footer">Employee terminations and access changes</p>
            <a class="btn" href="./mock_data/terminated_users.csv" download style="margin-top:12px">
              ‚¨á Download Sample CSV
            </a>
          </div>
          <div class="card col-4" style="background:var(--panel-2)">
            <h4>IT Directory</h4>
            <p class="footer">Active user accounts and permissions</p>
            <a class="btn" href="./mock_data/user_directory.csv" download style="margin-top:12px">
              ‚¨á Download Sample CSV
            </a>
          </div>
          <div class="card col-4" style="background:var(--panel-2)">
            <h4>Finance System</h4>
            <p class="footer">Journal entries and approvals</p>
            <a class="btn" href="./mock_data/journal_entries.csv" download style="margin-top:12px">
              ‚¨á Download Sample CSV
            </a>
          </div>
        </div>
      </div>

      <div id="tests" class="card col-12">
        <h3>Control Testing</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Control ID</th>
              <th>Control Description</th>
              <th>Evidence Required</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>ACC-01</strong></td>
              <td>Terminated User Access Removal</td>
              <td>
                <span class="badge">terminated_users.csv</span>
                <span class="badge">user_directory.csv</span>
              </td>
              <td><span class="pill warn" id="status-ACC-01">Pending</span></td>
              <td>
                <button class="btn primary" onclick="openTestModal('ACC-01', 'Terminated User Access Removal')" style="padding:6px 12px;font-size:13px;border:none;cursor:pointer">
                  Test Control
                </button>
              </td>
            </tr>
            <tr>
              <td><strong>FIN-02</strong></td>
              <td>Journal Entry Approval >$10,000</td>
              <td>
                <span class="badge">journal_entries.csv</span>
              </td>
              <td><span class="pill warn">Pending</span></td>
              <td>
                <a class="btn primary" href="/sox-auditor.html" style="padding:6px 12px;font-size:13px">
                  Test Control
                </a>
              </td>
            </tr>
            <tr>
              <td><strong>IT-03</strong></td>
              <td>Privileged Access Review</td>
              <td>
                <span class="badge">user_directory.csv</span>
              </td>
              <td><span class="pill ok">Effective</span></td>
              <td>
                <a class="btn" href="/big4-reviewer.html" style="padding:6px 12px;font-size:13px">
                  Review Workpaper
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="reports" class="card col-12">
        <h3>Reports & Documentation</h3>
        <p class="footer">Generate compliance reports and export workpapers for external review.</p>
        <div style="margin-top:20px;display:flex;gap:12px">
          <a class="btn" href="#" onclick="notImplemented(event)">üìä Q4 SOX Report</a>
          <a class="btn" href="#" onclick="notImplemented(event)">üìà Control Matrix</a>
          <a class="btn" href="#" onclick="notImplemented(event)">üìã Audit Trail</a>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Control Testing Modal -->
<div id="testModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Test Control</h2>
      <button class="modal-close" onclick="closeTestModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:12px;color:var(--gray)">
        For ACC-01, enter the user IDs you want to audit (e.g., u1001, u1002, u1003)
      </p>
      <textarea 
        id="testData" 
        placeholder="Enter user IDs to audit: u1001, u1002, u1003, u1004, u1005"
      ></textarea>
      <div id="testResults" class="modal-results" style="display:none;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeTestModal()">Cancel</button>
      <button class="btn" id="exportExcelBtn" onclick="exportToExcel()" style="display:none;">
        üìä Export to Excel
      </button>
      <button class="btn primary" id="submitTestBtn" onclick="submitTest()">
        <span id="submitBtnText">Submit Test</span>
      </button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>
<script>
function toast(msg, ms=2000){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.style.display='block';
  setTimeout(()=>t.style.display='none',ms)
}
function notImplemented(e){
  e.preventDefault();
  toast('This feature is coming soon!')
}

// Modal functionality
let currentControlId = '';
let sessionId = '';
let lastTestResults = null; // Store the last test results for export

function openTestModal(controlId, controlName) {
  currentControlId = controlId;
  sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  const modal = document.getElementById('testModal');
  const modalTitle = document.getElementById('modalTitle');
  modalTitle.textContent = `Test Control: ${controlId} - ${controlName}`;
  
  // Reset modal state
  document.getElementById('testData').value = '';
  document.getElementById('testResults').style.display = 'none';
  document.getElementById('testResults').innerHTML = '';
  document.getElementById('submitBtnText').textContent = 'Submit Test';
  document.getElementById('submitTestBtn').disabled = false;
  document.getElementById('exportExcelBtn').style.display = 'none';
  lastTestResults = null;
  
  modal.style.display = 'block';
}

function closeTestModal() {
  document.getElementById('testModal').style.display = 'none';
}

async function submitTest() {
  const testData = document.getElementById('testData').value.trim();
  if (!testData) {
    toast('Please enter user IDs to test');
    return;
  }
  
  const submitBtn = document.getElementById('submitTestBtn');
  const submitBtnText = document.getElementById('submitBtnText');
  const resultsDiv = document.getElementById('testResults');
  
  // Disable button and show loading
  submitBtn.disabled = true;
  submitBtnText.innerHTML = '<span class="loading-spinner"></span>Testing...';
  
  try {
    // Determine the correct API URL
    const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? 'http://localhost:3007/api/assistants/sox-auditor/chat'  // Local development
      : '/api/assistants/sox-chat';  // Production on Vercel
    
    // Call the SOX auditor API
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: `Please audit the following terminated users: ${testData}`,
        sessionId: sessionId
      }),
    });
    
    let data;
    const contentType = response.headers.get("content-type");
    if (contentType && contentType.includes("application/json")) {
      data = await response.json();
    } else {
      const text = await response.text();
      console.error('Non-JSON response:', text);
      throw new Error('Server returned invalid response. Please check if the API is running.');
    }
    
    if (response.ok) {
      // Store results for export
      lastTestResults = {
        controlId: currentControlId,
        response: data.response,
        timestamp: new Date().toISOString(),
        userIds: testData
      };
      
      // Display results
      resultsDiv.innerHTML = formatResults(data.response);
      resultsDiv.style.display = 'block';
      
      // Show export button
      document.getElementById('exportExcelBtn').style.display = 'inline-block';
      
      // Update control status if test passed
      if (data.response.includes('PASSED') || data.response.includes('Effective')) {
        const statusPill = document.getElementById(`status-${currentControlId}`);
        if (statusPill) {
          statusPill.className = 'pill ok';
          statusPill.textContent = 'Tested';
        }
      }
      
      submitBtnText.textContent = 'Test Complete';
      toast('Control test completed successfully');
    } else {
      throw new Error(data.error || 'Test failed');
    }
  } catch (error) {
    console.error('Error testing control:', error);
    resultsDiv.innerHTML = `<div style="color:var(--bad)">Error: ${error.message}</div>`;
    resultsDiv.style.display = 'block';
    submitBtnText.textContent = 'Test Failed';
    toast('Error: ' + error.message, 3000);
  } finally {
    // Re-enable button after a delay
    setTimeout(() => {
      submitBtn.disabled = false;
      submitBtnText.textContent = 'Run Another Test';
    }, 2000);
  }
}

function formatResults(response) {
  // Format the response for better display
  let formatted = response
    .replace(/### /g, '<h4 style="margin:16px 0 8px;color:var(--primary)">')
    .replace(/\n\n/g, '</p><p style="margin:8px 0">')
    .replace(/\n- /g, '</li><li>')
    .replace(/- /g, '<ul style="margin:8px 0;padding-left:20px"><li>')
    .replace(/<li>(.*?)\n/g, '<li>$1</li></ul>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/PASSED/g, '<span style="color:var(--ok);font-weight:600">PASSED</span>')
    .replace(/FAILED/g, '<span style="color:var(--bad);font-weight:600">FAILED</span>')
    .replace(/Effective/g, '<span style="color:var(--ok);font-weight:600">Effective</span>')
    .replace(/Ineffective/g, '<span style="color:var(--bad);font-weight:600">Ineffective</span>');
  
  // Wrap in paragraph tags if not already formatted
  if (!formatted.includes('<')) {
    formatted = '<p>' + formatted + '</p>';
  }
  
  return formatted;
}

// Export results to Excel
async function exportToExcel() {
  if (!lastTestResults) {
    toast('No test results to export');
    return;
  }
  
  try {
    // Parse the test results
    const parseResults = parseTestResultsForExcel(lastTestResults.response);
    
    // Fetch the template
    const response = await fetch('/templates/sox_lead_sheet_template.xlsx');
    const templateBuffer = await response.arrayBuffer();
    
    // Read the template workbook
    const workbook = XLSX.read(templateBuffer, { type: 'array' });
    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
    
    // Fill in the template fields
    const today = new Date().toISOString().split('T')[0];
    
    // Control Information
    worksheet['B4'] = { t: 's', v: 'ACC-01' };
    worksheet['B5'] = { t: 's', v: 'Terminated User Access Removal' };
    worksheet['B6'] = { t: 's', v: 'Access Control' };
    worksheet['B7'] = { t: 's', v: 'IT Security Team' };
    worksheet['B8'] = { t: 's', v: parseResults.testingPeriodStart || today };
    worksheet['B9'] = { t: 's', v: parseResults.testingPeriodEnd || today };
    
    // Population & Sampling
    worksheet['B12'] = { t: 's', v: 'HR Termination Report & Active Directory' };
    worksheet['B13'] = { t: 'n', v: parseResults.sampleSize || 0 };
    worksheet['B14'] = { t: 'n', v: parseResults.sampleSize || 0 };
    worksheet['B15'] = { t: 's', v: 'Judgmental - High Risk Users' };
    worksheet['B16'] = { t: 's', v: 'Yes - Cross-referenced with AD' };
    worksheet['B17'] = { t: 's', v: parseResults.notes || 'Automated SOX testing performed' };
    
    // Results Summary
    worksheet['B28'] = { t: 'n', v: parseResults.sampleSize || 0 };
    worksheet['B29'] = { t: 'n', v: parseResults.sampleSize || 0 };
    worksheet['B30'] = { t: 'n', v: parseResults.exceptions || 0 };
    worksheet['B31'] = { t: 's', v: parseResults.exceptionRate || '0%' };
    worksheet['B32'] = { t: 's', v: parseResults.controlConclusion || 'Pending' };
    
    // Exception Details - Start from row 36
    if (parseResults.details && parseResults.details.length > 0) {
      let currentRow = 36;
      parseResults.details.forEach((detail, index) => {
        if (currentRow <= 50) { // Limit to prevent overwriting other sections
          worksheet['A' + currentRow] = { t: 's', v: detail.userId || '' };
          worksheet['B' + currentRow] = { t: 's', v: detail.userName || '' };
          worksheet['C' + currentRow] = { t: 's', v: detail.terminationDate || '' };
          worksheet['D' + currentRow] = { t: 's', v: detail.disableDate || '' };
          worksheet['E' + currentRow] = { t: 's', v: detail.hoursToDisable || '' };
          worksheet['F' + currentRow] = { t: 's', v: detail.status || '' };
          worksheet['G' + currentRow] = { t: 's', v: detail.exceptionReason || '' };
          currentRow++;
        }
      });
    }
    
    // Sign-off
    worksheet['B39'] = { t: 's', v: 'SOX Auditor (Automated)' };
    worksheet['B40'] = { t: 's', v: today };
    worksheet['B41'] = { t: 's', v: 'Pending Review' };
    worksheet['B42'] = { t: 's', v: '' };
    worksheet['B43'] = { t: 's', v: 'Pending' };
    worksheet['B44'] = { t: 's', v: '' };
    
    // Write the workbook
    const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
    
    // Create a blob and download
    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `SOX_Lead_Sheet_ACC01_${today.replace(/-/g, '')}.xlsx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    toast('Excel file exported successfully');
  } catch (error) {
    console.error('Export error:', error);
    toast('Error exporting to Excel: ' + error.message, 3000);
  }
}

// Parse test results for Excel export
function parseTestResultsForExcel(response) {
  const result = {
    sampleSize: 0,
    exceptions: 0,
    exceptionRate: '0%',
    controlConclusion: 'Pending',
    details: [],
    notes: '',
    testingPeriodStart: '',
    testingPeriodEnd: ''
  };
  
  try {
    // Extract sample size
    const sampleMatch = response.match(/Sample Size:\s*(\d+)/i);
    if (sampleMatch) result.sampleSize = parseInt(sampleMatch[1]);
    
    // Extract exceptions/failed
    const failedMatch = response.match(/Failed:\s*(\d+)/i);
    if (failedMatch) result.exceptions = parseInt(failedMatch[1]);
    
    // Extract exception rate
    const rateMatch = response.match(/Exception Rate:\s*([\d.]+%)/i);
    if (rateMatch) result.exceptionRate = rateMatch[1];
    
    // Extract control effectiveness
    const effectiveMatch = response.match(/Control Effectiveness:\s*(\w+)/i);
    if (effectiveMatch) result.controlConclusion = effectiveMatch[1];
    
    // Parse detailed findings
    const userIdPattern = /User ID:\s*(u\d+)/gi;
    const namePattern = /User Name:\s*([^\n]+)/gi;
    const termPattern = /Termination Time:\s*([^\n]+)/gi;
    const disablePattern = /Account Disabled Time:\s*([^\n]+)/gi;
    const statusPattern = /Status:\s*(PASSED|FAILED)/gi;
    
    // Extract all user details
    const userIds = [...response.matchAll(userIdPattern)];
    const names = [...response.matchAll(namePattern)];
    const termTimes = [...response.matchAll(termPattern)];
    const disableTimes = [...response.matchAll(disablePattern)];
    const statuses = [...response.matchAll(statusPattern)];
    
    // Combine into detail objects
    for (let i = 0; i < userIds.length; i++) {
      const detail = {
        userId: userIds[i] ? userIds[i][1] : '',
        userName: names[i] ? names[i][1] : '',
        terminationDate: termTimes[i] ? termTimes[i][1] : '',
        disableDate: disableTimes[i] ? disableTimes[i][1] : 'Not disabled',
        hoursToDisable: '',
        status: statuses[i] ? statuses[i][1] : '',
        exceptionReason: ''
      };
      
      // Calculate hours to disable if both dates present
      if (detail.terminationDate && detail.disableDate && detail.disableDate !== 'Not disabled') {
        try {
          const termDate = new Date(detail.terminationDate);
          const disDate = new Date(detail.disableDate);
          const diffMinutes = Math.round((disDate - termDate) / (1000 * 60));
          detail.hoursToDisable = `${Math.round(diffMinutes / 60)}h ${diffMinutes % 60}m`;
          if (diffMinutes > 10) {
            detail.exceptionReason = `Exceeded 10-minute requirement (${diffMinutes} minutes)`;
          }
        } catch (e) {
          // Date parsing error
        }
      } else if (detail.status === 'FAILED') {
        detail.exceptionReason = 'Account not disabled';
      }
      
      result.details.push(detail);
    }
    
    // Set testing period (last 30 days for example)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    result.testingPeriodStart = startDate.toISOString().split('T')[0];
    result.testingPeriodEnd = endDate.toISOString().split('T')[0];
    
  } catch (error) {
    console.error('Error parsing results:', error);
  }
  
  return result;
}

// Close modal when clicking outside of it
window.onclick = function(event) {
  const modal = document.getElementById('testModal');
  if (event.target === modal) {
    closeTestModal();
  }
}
</script>
</body></html>